<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTB Trails & Spots</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #2d5016;
            --secondary-green: #4a7c2c;
            --accent-orange: #d97316;
            --earth-brown: #6b4423;
            --light-beige: #f4f1ea;
            --dark-gray: #2c2c2c;
            --white: #ffffff;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-beige);
            color: var(--dark-gray);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }

        /* GRID LAYOUT */
        .parent {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: 60px 60px 1fr;
            gap: 8px;
            height: 100vh;
            padding: 8px;
        }

        /* DIV1 - Logo/Name */
        .div1 {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* DIV2, DIV3, DIV4 - Navigation */
        .div2, .div3, .div4 {
            background-color: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--primary-green);
            position: relative;
        }

        .div2:hover, .div3:hover, .div4:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background-color: var(--light-beige);
        }

        .admin-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            min-width: 200px;
            box-shadow: var(--shadow-lg);
            border-radius: 8px;
            margin-top: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .div4:hover .admin-dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--light-beige);
        }

        /* DIV5 - Suchleiste */
        .div5 {
            grid-column: span 5;
            grid-row-start: 2;
            background-color: var(--white);
            border-radius: 8px;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .search-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .search-icon {
            font-size: 1.3rem;
            color: var(--secondary-green);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 1rem;
            padding: 0.5rem;
            background: transparent;
        }

        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--white);
            border-radius: 0 0 8px 8px;
            box-shadow: var(--shadow-lg);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 8px;
        }

        .search-results-dropdown.active {
            display: block;
        }

        .search-result-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--light-beige);
            transition: background-color 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: var(--light-beige);
        }

        .search-result-icon {
            font-size: 1.2rem;
            margin-right: 0.8rem;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 0.3rem;
        }

        .search-result-subtitle {
            font-size: 0.85rem;
            color: #666;
        }

        .search-result-type {
            display: inline-block;
            background-color: var(--secondary-green);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .instruction-text {
            color: var(--earth-brown);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* DIV6 - Karte */
        .div6 {
            grid-column: span 3;
            grid-row-start: 3;
            background-color: var(--white);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-layer-control {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .layer-btn {
            background-color: var(--light-beige);
            border: 2px solid transparent;
            padding: 0.5rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--dark-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .layer-btn:hover {
            background-color: #e8e4db;
            transform: translateY(-2px);
        }

        .layer-btn.active {
            background-color: var(--secondary-green);
            color: var(--white);
            border-color: var(--primary-green);
        }

        /* Ma√üstab Styling */
        .leaflet-control-scale {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .leaflet-control-scale-line {
            border: 2px solid var(--primary-green);
            border-top: none;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--dark-gray);
            padding: 2px 5px;
            box-shadow: var(--shadow-sm);
        }

        /* Tourpaket-Hervorhebung */
        .tourpaket-highlight-ring {
            position: absolute;
            border: 3px solid var(--accent-orange);
            border-radius: 50%;
            animation: pulseRing 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes pulseRing {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.3;
            }
        }

        /* Route Info Box auf Karte */
        .route-info-overlay {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.98);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            min-width: 350px;
            border: 3px solid var(--secondary-green);
        }

        .route-info-overlay h3 {
            color: var(--primary-green);
            margin-bottom: 0.8rem;
            font-size: 1.3rem;
        }

        .route-info-overlay p {
            margin: 0.5rem 0;
            color: var(--dark-gray);
            font-size: 0.95rem;
        }

        .route-point-count {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-orange);
            margin: 1rem 0;
            padding: 0.5rem;
            background-color: var(--light-beige);
            border-radius: 8px;
        }

        .route-overlay-buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .route-overlay-buttons .btn {
            flex: 1;
            margin: 0;
        }

        /* Group Info Badge */
        .group-info-badge {
            background-color: var(--accent-orange);
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* MARKER TYPE SELECTION MODAL */
        .type-selection-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1500;
            background-color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 400px;
            max-width: 500px;
            border: 3px solid var(--secondary-green);
        }

        .type-selection-modal.active {
            display: block;
        }

        .type-selection-modal h3 {
            color: var(--primary-green);
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.3rem;
        }

        .type-selection-modal .instruction {
            text-align: center;
            color: #666;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .type-buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .type-btn {
            padding: 1rem;
            border: 2px solid var(--light-beige);
            border-radius: 8px;
            background-color: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
            color: var(--dark-gray);
        }

        .type-btn:hover {
            background-color: var(--light-beige);
            border-color: var(--secondary-green);
            transform: translateY(-2px);
        }

        .type-modal-cancel {
            width: 100%;
            margin-top: 1rem;
        }

        .div7 {
            grid-column-start: 4;
            grid-column: span 2;
            grid-row-start: 3;
            background-color: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--light-beige);
            padding-bottom: 0.5rem;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background-color: var(--secondary-green);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-green);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--accent-orange);
            color: var(--white);
        }

        .btn-secondary:hover {
            background-color: #c2640f;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background-color: #999;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #777;
        }

        .marker-list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .marker-item {
            background-color: var(--light-beige);
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-green);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .marker-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .marker-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .marker-item-title {
            font-weight: 600;
            color: var(--primary-green);
        }

        .marker-item-type {
            font-size: 1.2rem;
        }

        .marker-item-coords {
            font-size: 0.8rem;
            color: #666;
        }

        .marker-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .show-on-map-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
        }

        .show-on-map-btn:hover {
            background-color: #2563eb;
        }

        .delete-marker-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
        }

        .delete-marker-btn:hover {
            display: inline-block;
            background-color: var(--accent-orange);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .delete-marker-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .delete-marker-btn:hover {
            background-color: #b91c1c;
        }

        .marker-group-badge {
            display: inline-block;
            background-color: var(--accent-orange);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        /* Gruppen-Item in Modal */
        .group-item-card {
            background-color: var(--light-beige);
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-green);
        }

        .group-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .group-item-title {
            font-weight: 600;
            color: var(--primary-green);
            font-size: 1rem;
        }

        .group-item-icon {
            font-size: 1.5rem;
        }

        .group-item-type {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .group-item-coords {
            font-size: 0.8rem;
            color: #888;
        }

        /* Aktive Gruppe Anzeige */
        .active-group-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #e0f2e9;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-green);
        }

        .active-group-info p {
            margin-bottom: 0.5rem;
        }

        .active-group-info .group-title {
            font-weight: 600;
            color: var(--primary-green);
        }

        .active-group-info .group-count {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.8rem;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            position: relative;
            transition: all 0.3s ease;
        }

        .modal-content.minimized {
            max-width: 300px;
            padding: 1.5rem;
            position: fixed;
            top: 20px;
            right: 20px;
            max-height: 200px;
            z-index: 2001;
        }

        .modal-content.minimized h2 {
            font-size: 1rem;
            margin-bottom: 0.8rem;
        }

        .modal-content.minimized .form-group,
        .modal-content.minimized .sidebar-section,
        .modal-content.minimized #groupItemsList {
            display: none;
        }

        .modal-content.minimized .form-buttons {
            margin-top: 0.5rem;
        }

        .modal-content.minimized .btn {
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .minimize-toggle-btn {
            position: absolute;
            top: 1rem;
            right: 3.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .minimize-toggle-btn:hover {
            color: var(--dark-gray);
        }

        /* Admin Login Modal */
        .admin-login-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .admin-login-overlay.active {
            display: flex;
        }

        .admin-login-box {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 90%;
        }

        .admin-login-box h2 {
            color: var(--primary-green);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .admin-code-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid var(--secondary-green);
            border-radius: 8px;
            margin-bottom: 1rem;
            letter-spacing: 0.5rem;
        }

        .admin-code-input:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2500;
            overflow-y: auto;
        }

        .admin-dashboard.active {
            display: block;
        }

        .admin-dashboard-content {
            background-color: var(--white);
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 12px;
            max-width: 1200px;
            width: 95%;
            box-shadow: var(--shadow-lg);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary-green);
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .admin-tab {
            padding: 0.8rem 1.5rem;
            background-color: var(--light-beige);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-tab:hover {
            background-color: #e8e4db;
        }

        .admin-tab.active {
            background-color: var(--secondary-green);
            color: white;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .suggestion-card {
            background-color: var(--light-beige);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-orange);
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .suggestion-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-green);
        }

        .suggestion-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-pending {
            background-color: #f59e0b;
            color: white;
        }

        .suggestion-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-approve {
            background-color: #10b981;
            color: white;
            flex: 1;
        }

        .btn-approve:hover {
            background-color: #059669;
        }

        .btn-reject {
            background-color: #ef4444;
            color: white;
            flex: 1;
        }

        .btn-reject:hover {
            background-color: #dc2626;
        }

        .modal-close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--dark-gray);
        }

        .modal-content h2 {
            color: var(--primary-green);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-green);
        }

        .form-group textarea {
            resize: none;
            overflow: hidden;
            min-height: 60px;
            max-height: 300px;
        }

        .form-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .form-buttons .btn {
            flex: 1;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .parent {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto 400px 1fr;
                gap: 8px;
            }

            .div1, .div2, .div3, .div4, .div5, .div6, .div7 {
                grid-column: 1 !important;
                grid-row: auto !important;
            }

            .logo-text {
                font-size: 1.2rem;
            }

            .map-layer-control {
                flex-wrap: wrap;
            }

            .instruction-text {
                display: none;
            }

            .route-info-overlay {
                min-width: 300px;
                padding: 1rem 1.5rem;
            }

            .type-selection-modal {
                min-width: 300px;
                max-width: 90%;
            }

            .type-buttons-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="parent">
        <!-- DIV1 - Logo/Name -->
        <div class="div1">
            <div class="logo">
                <span class="logo-icon">üöµ</span>
                <span class="logo-text">MTB Trails</span>
            </div>
        </div>

        <!-- DIV2 - Strecken -->
        <div class="div2" onclick="alert('Strecken-Seite kommt bald!')">
            Strecken
        </div>

        <!-- DIV3 - Aktuelles -->
        <div class="div3" onclick="alert('Aktuelles-Seite kommt bald!')">
            Aktuelles
        </div>

        <!-- DIV4 - Admin -->
        <div class="div4" onclick="showAdminLogin()">
            <span>‚öôÔ∏è Admin</span>
        </div>

        <!-- DIV5 - Suchleiste -->
        <div class="div5">
            <div class="search-container" style="position: relative;">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Suche nach Markern, St√§dten, Orten oder Koordinaten...">
                
                <!-- Such-Ergebnisse Dropdown -->
                <div class="search-results-dropdown" id="searchResultsDropdown">
                    <!-- Wird dynamisch bef√ºllt -->
                </div>
            </div>
            <span class="instruction-text">üí° Klicke auf die Karte, um einen Marker zu setzen</span>
        </div>

        <!-- DIV6 - Karte -->
        <div class="div6">
            <div class="map-layer-control">
                <button class="layer-btn active" data-layer="standard">üó∫Ô∏è Standard</button>
                <button class="layer-btn" data-layer="satellite">üõ∞Ô∏è Satellit</button>
                <button class="layer-btn" data-layer="hybrid">üåç Hybrid</button>
                <button class="layer-btn" data-layer="terrain">‚õ∞Ô∏è Terrain</button>
            </div>
            
            <!-- Marker Type Selection Modal (auf Karte) -->
            <div id="typeSelectionModal" class="type-selection-modal">
                <h3>üìç Marker-Art w√§hlen</h3>
                <p class="instruction">W√§hle die Art des Markers:</p>
                
                <div class="type-buttons-grid">
                    <button class="type-btn" onclick="selectType('danger')">‚ö†Ô∏è Gefahrenstelle</button>
                    <button class="type-btn" onclick="selectType('viewpoint')">üèîÔ∏è Aussichtspunkt</button>
                    <button class="type-btn" onclick="selectType('service')">üîß Service</button>
                    <button class="type-btn" onclick="selectType('parking')">üÖøÔ∏è Parkplatz</button>
                    <button class="type-btn" onclick="selectType('startpoint')">üèÅ Startpunkt</button>
                    <button class="type-btn" onclick="selectType('route')">üöµ Strecke</button>
                </div>
                
                <button class="btn btn-cancel type-modal-cancel" onclick="cancelMarkerCreation()">‚ùå Abbrechen</button>
            </div>
            
            <!-- Route Info Overlay -->
            <div id="routeInfoOverlay" class="route-info-overlay" style="display: none;">
                <h3 id="overlayTitle">üìç Strecke zeichnen</h3>
                <p id="overlayInstruction">Klicke auf die Karte, um Wegpunkte zu setzen</p>
                <div id="groupInfoContainer" class="group-info-badge" style="display: none;">
                    Tourpaket: <span id="currentGroupName"></span>
                </div>
                <div class="route-point-count"><span id="routePointCountOverlay">0</span> Punkte</div>
                <div class="route-overlay-buttons">
                    <button class="btn btn-primary" onclick="finishRouteDrawing()">‚úÖ Beenden</button>
                    <button class="btn btn-cancel" onclick="cancelRouteDrawing()">‚ùå Abbrechen</button>
                </div>
            </div>
            
            <div id="map"></div>
        </div>

        <!-- DIV7 - Sidebar -->
        <div class="div7">
            <!-- Aktives Tourpaket Anzeige -->
            <div id="activeGroupInfo" class="active-group-info" style="display: none;">
                <p class="group-title">üîó Aktives Tourpaket: <span id="activeGroupNameSidebar"></span></p>
                <p class="group-count"><span id="groupItemCount">0</span> Element(e) in diesem Tourpaket</p>
                <button class="btn btn-primary" onclick="addToCurrentGroup()">
                    üì¶ Tourpaket verwalten
                </button>
            </div>

            <div class="sidebar-section">
                <h3>üìä Statistik</h3>
                <p style="font-size: 1.2rem; font-weight: 600; color: var(--secondary-green);">
                    <span id="markerCount">0</span> Marker auf der Karte
                </p>
            </div>

            <div class="sidebar-section">
                <h3>üìç Ver√∂ffentlichte Marker</h3>
                <div class="marker-list-container" id="markerListContainer">
                    <p style="color: #999; text-align: center; padding: 1rem;">Noch keine Marker</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="markerModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h2 id="modalTitle">Marker-Details eingeben</h2>
            
            <form id="markerForm" autocomplete="off" autocorrect="off" autocapitalize="off">
                <div class="form-group" id="markerTypeDisplay">
                    <label>Marker-Typ</label>
                    <div style="padding: 0.8rem; background-color: var(--light-beige); border-radius: 5px; font-weight: 600;">
                        <span id="selectedTypeLabel"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="markerName">Name/Titel</label>
                    <input type="text" id="markerName" name="marker-name-field-unique" required placeholder="z.B. Flow Trail Waldweg" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                </div>

                <div class="form-group" id="difficultyGroup" style="display: none;">
                    <label for="markerDifficulty">Schwierigkeit</label>
                    <select id="markerDifficulty" autocomplete="off">
                        <option value="easy">Leicht (Gr√ºn)</option>
                        <option value="medium">Mittel (Blau)</option>
                        <option value="hard">Schwer (Rot)</option>
                        <option value="extreme">Extrem (Schwarz)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="markerDescription">Beschreibung</label>
                    <textarea id="markerDescription" rows="3" placeholder="Beschreibe die Strecke..." autocomplete="off"></textarea>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" id="sendEmailBtn" onclick="sendMarkerEmail()">üìß Jetzt senden</button>
                    <button type="button" class="btn btn-primary" id="addToGroupBtn" onclick="addMarkerToGroup()">üîó Verkn√ºpfung erstellen</button>
                    <button type="button" class="btn btn-cancel" id="cancelBtn" onclick="closeModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tourpaket-√úbersichts-Modal -->
    <div class="modal" id="groupOverviewModal">
        <div class="modal-content" id="groupModalContent" style="max-width: 600px;">
            <button class="minimize-toggle-btn" id="minimizeToggleBtn" onclick="toggleMinimizeGroupModal()">üìê</button>
            <span class="modal-close" onclick="closeGroupOverviewModal()">&times;</span>
            <h2>üì¶ Tourpaket-√úbersicht</h2>
            
            <div class="form-group">
                <label for="groupNameInput">Tourpaket-Name</label>
                <input type="text" id="groupNameInput" placeholder="z.B. Waldtrail S√ºd" autocomplete="off">
            </div>

            <div class="sidebar-section">
                <h3>üìç Elemente in diesem Tourpaket (<span id="groupItemCountModal">0</span>)</h3>
                <div id="groupItemsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Wird dynamisch bef√ºllt -->
                </div>
            </div>

            <div class="form-buttons">
                <button type="button" class="btn btn-primary" onclick="showGroupOnMap()" style="background-color: #3b82f6;">üó∫Ô∏è Auf Karte anzeigen</button>
            </div>

            <div class="form-buttons" style="margin-top: 0.5rem;">
                <button type="button" class="btn btn-primary" onclick="addAnotherToGroup()">‚ûï Weiteren Punkt hinzuf√ºgen</button>
                <button type="button" class="btn btn-secondary" onclick="sendGroupFromModal()">üìß Tourpaket senden</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="admin-login-overlay" id="adminLoginOverlay">
        <div class="admin-login-box">
            <h2>üîê Admin-Bereich</h2>
            <input type="password" class="admin-code-input" id="adminCodeInput" placeholder="Code eingeben" maxlength="5" autocomplete="off">
            <button class="btn btn-primary" onclick="checkAdminCode()">üîì Entsperren</button>
            <button class="btn btn-cancel" onclick="closeAdminLogin()">Abbrechen</button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-dashboard-content">
            <div class="admin-header">
                <h1>‚öôÔ∏è Admin-Dashboard</h1>
                <button class="btn btn-cancel" onclick="closeAdminDashboard()">‚úï Schlie√üen</button>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('suggestions')">üì® Vorschl√§ge (<span id="suggestionCount">0</span>)</button>
                <button class="admin-tab" onclick="switchAdminTab('markers')">üìç Alle Marker</button>
                <button class="admin-tab" onclick="switchAdminTab('stats')">üìä Statistiken</button>
                <button class="admin-tab" onclick="switchAdminTab('backup')">üíæ Backup</button>
            </div>

            <!-- Tab: Vorschl√§ge -->
            <div class="admin-tab-content active" id="tab-suggestions">
                <h3>üì® Marker-Vorschl√§ge von Nutzern</h3>
                <div id="suggestionsList">
                    <p style="color: #999; text-align: center; padding: 2rem;">Keine neuen Vorschl√§ge</p>
                </div>
            </div>

            <!-- Tab: Alle Marker -->
            <div class="admin-tab-content" id="tab-markers">
                <h3>üìç Alle Marker verwalten</h3>
                <p style="margin-bottom: 1rem;">Gesamt: <strong><span id="totalMarkerCount">0</span></strong> Marker</p>
                <div id="adminMarkerList" style="max-height: 600px; overflow-y: auto;">
                    <!-- Wird dynamisch bef√ºllt -->
                </div>
            </div>

            <!-- Tab: Statistiken -->
            <div class="admin-tab-content" id="tab-stats">
                <h3>üìä Website-Statistiken</h3>
                
                <div style="background-color: var(--light-beige); padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-top: 0; color: var(--primary-green);">üë• Besucher</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                        <div>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Gesamte Seitenaufrufe:</p>
                            <p style="font-size: 3rem; font-weight: bold; color: var(--primary-green); margin: 0;">
                                <span id="pageviewCount">0</span>
                            </p>
                        </div>
                        
                        <div>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Letzter Besuch:</p>
                            <p style="font-size: 1.2rem; font-weight: 600; color: var(--accent-orange); margin-top: 1rem;">
                                <span id="lastVisit">Noch keine Besuche</span>
                            </p>
                        </div>
                    </div>
                    
                    <p style="font-size: 0.85rem; color: #999; margin-top: 1.5rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                        üí° Hinweis: Jeder Browser-Tab z√§hlt nur 1x pro Session (bis Browser geschlossen wird)
                    </p>
                </div>

                <div style="background-color: var(--light-beige); padding: 2rem; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: var(--primary-green);">üìç Content-Statistiken</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Ver√∂ffentlichte Marker</p>
                            <p style="font-size: 2rem; font-weight: bold; color: var(--secondary-green); margin: 0;">
                                <span id="statsMarkerCount">0</span>
                            </p>
                        </div>
                        
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Wartende Vorschl√§ge</p>
                            <p style="font-size: 2rem; font-weight: bold; color: var(--accent-orange); margin: 0;">
                                <span id="statsSuggestionCount">0</span>
                            </p>
                        </div>
                        
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Tourpakete</p>
                            <p style="font-size: 2rem; font-weight: bold; color: #3b82f6; margin: 0;">
                                <span id="statsTourpaketCount">0</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Backup -->
            <div class="admin-tab-content" id="tab-backup">
                <h3>üíæ Backup & Wiederherstellung</h3>
                
                <div style="background-color: var(--light-beige); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-top: 0;">üì• Backup herunterladen</h4>
                    <p style="margin-bottom: 1rem;">Exportiere alle Marker als CSV-Datei f√ºr Excel:</p>
                    <button class="btn btn-primary" onclick="exportMarkersAdmin()">üì• CSV-Backup erstellen</button>
                </div>

                <div style="background-color: var(--light-beige); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="margin-top: 0;">üì§ Backup wiederherstellen</h4>
                    <p style="margin-bottom: 1rem;">Importiere gespeicherte CSV-Datei:</p>
                    <input type="file" id="adminImportFile" accept=".csv" style="margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="importMarkersAdmin()">üì§ CSV importieren</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // ==================== FIREBASE KONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBmk6-WZp4g-lPfIrZBFMGKUB5SWpEmzdE",
            authDomain: "facharbeit-mtb-und-trails.firebaseapp.com",
            projectId: "facharbeit-mtb-und-trails",
            storageBucket: "facharbeit-mtb-und-trails.firebasestorage.app",
            messagingSenderId: "639798778772",
            appId: "1:639798778772:web:21ebded979a096873f4d81",
            measurementId: "G-C6KBMTZY5W"
        };

        // Firebase initialisieren
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('‚úÖ Firebase verbunden!');
        } catch (error) {
            console.error('‚ùå Firebase Fehler:', error);
            alert('‚ö†Ô∏è Firebase-Verbindung fehlgeschlagen. Offline-Modus aktiv.');
        }

        // ==================== VARIABLEN ====================
        let map;
        let currentLayer;
        let markers = [];
        let tempMarkerData = null;
        let routeMode = false;
        let routePoints = [];
        let tempPolyline = null;
        let tempRouteMarkers = []; // Array f√ºr die tempor√§ren Punkt-Marker
        let waitingForType = false;
        let clickedPosition = null;
        
        // Tourpaket-System
        let currentGroup = null; // { id, name, items: [], mainRoute: {} }
        let groupMode = false;
        let tempGroupPreviewMarkers = []; // Tempor√§re Marker/Linien f√ºr Tourpaket-Vorschau
        let tourpaketHighlightLayers = []; // Tempor√§re Hervorhebungs-Layer
        
        // Admin-System
        const ADMIN_CODE = '88888';
        let isAdminLoggedIn = false;
        let markerSuggestions = []; // Vorschl√§ge von Nutzern
        
        const ADMIN_EMAIL = 'Lenardo.krueger@icloud.com';

        const markerTypes = {
            trail: { name: 'Trail', icon: 'üöµ', color: '#4a7c2c' },
            danger: { name: 'Gefahrenstelle', icon: '‚ö†Ô∏è', color: '#dc2626' },
            viewpoint: { name: 'Aussichtspunkt', icon: 'üèîÔ∏è', color: '#2563eb' },
            service: { name: 'Service', icon: 'üîß', color: '#d97316' },
            parking: { name: 'Parkplatz', icon: 'üÖøÔ∏è', color: '#6366f1' },
            startpoint: { name: 'Startpunkt', icon: 'üèÅ', color: '#10b981' },
            route: { name: 'Strecke', icon: 'üìç', color: '#8b5cf6' }
        };

        const difficultyColors = {
            easy: '#22c55e',
            medium: '#3b82f6',
            hard: '#ef4444',
            extreme: '#000000'
        };

        const mapLayers = {
            standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            }),
            hybrid: L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }),
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 0.3,
                    maxZoom: 19
                })
            ]),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap',
                maxZoom: 17
            })
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM geladen - starte Initialisierung');
            setTimeout(() => {
                initMap();
                loadMarkersFromStorage();
                setupEventListeners();
                updateMarkerList();
                
                // Besucher-Z√§hler erh√∂hen
                trackPageView();
                
                // Admin-Code-Eingabe mit Enter
                const adminCodeInput = document.getElementById('adminCodeInput');
                if (adminCodeInput) {
                    adminCodeInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') checkAdminCode();
                    });
                }
            }, 100);
        });

        function initMap() {
            console.log('Initialisiere Karte...');
            try {
                map = L.map('map').setView([51.1657, 10.4515], 6);
                currentLayer = mapLayers.standard;
                currentLayer.addTo(map);
                
                // Ma√üstab hinzuf√ºgen
                L.control.scale({
                    position: 'bottomleft',
                    metric: true,
                    imperial: false,
                    maxWidth: 200
                }).addTo(map);
                
                map.on('click', onMapClick);
                
                // Zoom-Event f√ºr dynamische Marker-Gr√∂√üe
                map.on('zoomend', updateMarkerSizes);
                
                console.log('Karte erfolgreich initialisiert');
            } catch (error) {
                console.error('Fehler beim Initialisieren der Karte:', error);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    switchMapLayer(btn.dataset.layer);
                });
            });

            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('markerModal').addEventListener('click', (e) => {
                if (e.target.id === 'markerModal') closeModal();
            });

            const textarea = document.getElementById('markerDescription');
            if (textarea) {
                textarea.addEventListener('input', autoExpandTextarea);
            }

            // Such-Event-Listener
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                console.log('‚úÖ Suchfeld gefunden und Event-Listener registriert');
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const firstResult = document.querySelector('.search-result-item');
                        if (firstResult) {
                            firstResult.click();
                        }
                    }
                });
            } else {
                console.error('‚ùå Suchfeld nicht gefunden!');
            }

            // Klick au√üerhalb schlie√üt Dropdown
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    closeSearchDropdown();
                }
            });

            // Difficulty Dropdown: Route-Preview bei √Ñnderung aktualisieren
            const difficultySelect = document.getElementById('markerDifficulty');
            if (difficultySelect) {
                difficultySelect.addEventListener('change', () => {
                    if (routeMode && routePoints.length > 1) {
                        updateRoutePreview();
                    }
                });
            }
        }

        function switchMapLayer(layerType) {
            if (currentLayer) map.removeLayer(currentLayer);
            currentLayer = mapLayers[layerType];
            currentLayer.addTo(map);
        }

        function onMapClick(e) {
            console.log('Karte geklickt:', e.latlng, 'Route-Modus:', routeMode, 'Warte auf Typ:', waitingForType);
            
            if (routeMode) {
                // Strecken-Modus: Punkt zur Route hinzuf√ºgen
                routePoints.push([e.latlng.lat, e.latlng.lng]);
                updateRoutePreview();
                document.getElementById('routePointCountOverlay').textContent = routePoints.length;
                console.log('Route-Punkt hinzugef√ºgt. Gesamt:', routePoints.length);
            } else if (waitingForType) {
                // Warten auf Typ-Auswahl nach Gruppen-Hinzuf√ºgen
                if (window.pendingMarkerType) {
                    // Typ wurde schon gew√§hlt, jetzt Punkt setzen
                    clickedPosition = { lat: e.latlng.lat, lng: e.latlng.lng };
                    waitingForType = false;
                    tempMarkerData = { 
                        lat: clickedPosition.lat, 
                        lng: clickedPosition.lng, 
                        type: window.pendingMarkerType 
                    };
                    window.pendingMarkerType = null;
                    clickedPosition = null;
                    openModal();
                } else {
                    // Noch kein Typ gew√§hlt - ignorieren
                    return;
                }
            } else {
                // Erster Klick: Position speichern, Typ-Modal anzeigen
                clickedPosition = { lat: e.latlng.lat, lng: e.latlng.lng };
                waitingForType = true;
                showTypeSelectionModal();
            }
        }

        function showTypeSelectionModal() {
            document.getElementById('typeSelectionModal').classList.add('active');
        }

        function hideTypeSelectionModal() {
            document.getElementById('typeSelectionModal').classList.remove('active');
        }

        function selectType(type) {
            console.log('Typ ausgew√§hlt:', type);
            
            // Type Selection Modal schlie√üen
            hideTypeSelectionModal();
            waitingForType = false;

            if (type === 'route') {
                // Ganze Strecke: Strecken-Modus aktivieren
                routeMode = true;
                routePoints = [];
                
                // Overlay auf Karte anzeigen
                document.getElementById('routeInfoOverlay').style.display = 'block';
                document.getElementById('routePointCountOverlay').textContent = '0';
                
                if (groupMode && currentGroup) {
                    document.getElementById('overlayTitle').textContent = 'üìç Weitere Strecke zum Tourpaket';
                    document.getElementById('groupInfoContainer').style.display = 'block';
                    document.getElementById('currentGroupName').textContent = currentGroup.name;
                } else {
                    document.getElementById('overlayTitle').textContent = 'üìç Strecke zeichnen';
                    document.getElementById('groupInfoContainer').style.display = 'none';
                }
                
                console.log('Strecken-Modus aktiviert. Klicke auf die Karte, um Punkte zu setzen.');
            } else {
                // Normaler Marker - wenn im Gruppen-Modus, keinen clickedPosition Check
                if (groupMode && currentGroup && !clickedPosition) {
                    // Im Gruppen-Modus: Warte auf Klick auf Karte
                    waitingForType = true;
                    clickedPosition = null;
                    // Tempor√§r den Typ speichern
                    window.pendingMarkerType = type;
                    return;
                }
                
                tempMarkerData = { 
                    lat: clickedPosition.lat, 
                    lng: clickedPosition.lng, 
                    type: type 
                };
                openModal();
            }
            
            clickedPosition = null;
        }

        function cancelMarkerCreation() {
            waitingForType = false;
            clickedPosition = null;
            hideTypeSelectionModal();
        }

        function updateRoutePreview() {
            // Alte Linie entfernen
            if (tempPolyline) {
                map.removeLayer(tempPolyline);
            }

            // Alte Marker entfernen
            tempRouteMarkers.forEach(marker => map.removeLayer(marker));
            tempRouteMarkers = [];

            if (routePoints.length > 0) {
                const difficulty = document.getElementById('markerDifficulty').value || 'medium';
                const color = difficultyColors[difficulty];
                
                // Punkte als kleine Marker anzeigen
                routePoints.forEach((point, index) => {
                    const markerIcon = L.divIcon({
                        html: `<div style="
                            background-color: ${color};
                            color: white;
                            border-radius: 50%;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 12px;
                            border: 2px solid white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        ">${index + 1}</div>`,
                        className: 'route-point-marker',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker(point, { icon: markerIcon }).addTo(map);
                    tempRouteMarkers.push(marker);
                });

                // Linie zeichnen wenn mehr als 1 Punkt
                if (routePoints.length > 1) {
                    tempPolyline = L.polyline(routePoints, {
                        color: color,
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                }
                
                console.log('Route-Preview aktualisiert. Punkte:', routePoints.length, 'Farbe:', color);
            }
        }

        function finishRouteDrawing() {
            if (routePoints.length < 2) {
                alert('‚ö†Ô∏è Eine Strecke braucht mindestens 2 Punkte!');
                return;
            }

            console.log('Strecke wird beendet mit', routePoints.length, 'Punkten');

            // Overlay ausblenden
            document.getElementById('routeInfoOverlay').style.display = 'none';

            // Route-Daten vorbereiten
            tempMarkerData = {
                isRoute: true,
                points: [...routePoints],
                type: 'route'
            };

            // Modal √∂ffnen f√ºr Details-Eingabe
            document.getElementById('selectedTypeLabel').textContent = 'üìç Ganze Strecke';
            document.getElementById('difficultyGroup').style.display = 'block';
            
            if (groupMode && currentGroup) {
                // Bereits in Gruppen-Modus
                document.getElementById('modalTitle').textContent = 'Details f√ºr weitere Strecke';
            } else {
                // Erste Strecke
                document.getElementById('modalTitle').textContent = 'Strecke - Details eingeben';
            }
            
            openModal();
        }

        function cancelRouteDrawing() {
            if (!confirm('Strecke wirklich abbrechen?\n\nAlle gesetzten Punkte gehen verloren!')) {
                return;
            }

            // Route-Modus beenden
            routeMode = false;
            routePoints = [];
            
            // Overlay ausblenden
            document.getElementById('routeInfoOverlay').style.display = 'none';
            
            // Vorschau-Linie entfernen
            if (tempPolyline) {
                map.removeLayer(tempPolyline);
                tempPolyline = null;
            }

            // Punkt-Marker entfernen
            tempRouteMarkers.forEach(marker => map.removeLayer(marker));
            tempRouteMarkers = [];

            console.log('Strecken-Zeichnung abgebrochen');
        }

        function openModal() {
            document.getElementById('markerModal').classList.add('active');
            document.getElementById('markerForm').reset();
            const textarea = document.getElementById('markerDescription');
            textarea.style.height = 'auto';

            // Buttons-Sichtbarkeit und Text setzen
            const addToGroupBtn = document.getElementById('addToGroupBtn');
            
            if (groupMode && currentGroup) {
                // In Tourpaket-Modus: nur "Punkt/Strecke hinzuf√ºgen"
                document.getElementById('sendEmailBtn').style.display = 'none';
                addToGroupBtn.style.display = 'inline-block';
                addToGroupBtn.textContent = '‚ûï Punkt/Strecke hinzuf√ºgen';
            } else {
                // Kein Tourpaket-Modus: beide Buttons
                document.getElementById('sendEmailBtn').style.display = 'inline-block';
                addToGroupBtn.style.display = 'inline-block';
                addToGroupBtn.textContent = 'üîó Verkn√ºpfung mit anderen Punkt(en) erstellen';
            }

            // Typ-Label und Placeholder setzen
            if (tempMarkerData && tempMarkerData.type) {
                const typeConfig = markerTypes[tempMarkerData.type];
                document.getElementById('selectedTypeLabel').textContent = `${typeConfig.icon} ${typeConfig.name}`;
                
                // Dynamischer Placeholder basierend auf Typ
                const placeholders = {
                    danger: 'Beschreibe die Gefahrenstelle (z.B. steile Abfahrt, Wurzeln, loses Ger√∂ll)...',
                    viewpoint: 'Beschreibe den Aussichtspunkt (z.B. Blick ins Tal, Bergpanorama)...',
                    service: 'Beschreibe den Service-Punkt (z.B. Werkstatt, Luftpumpe, Reparatur)...',
                    parking: 'Beschreibe den Parkplatz (z.B. Anzahl Pl√§tze, Kosten, Ausstattung)...',
                    startpoint: 'Beschreibe den Startpunkt (z.B. Besonderheiten, Hinweise)...',
                    route: 'Beschreibe die Strecke (z.B. Untergrund, Highlights, Schwierigkeiten)...',
                    trail: 'Beschreibe den Trail (z.B. Flow, Technik, Landschaft)...'
                };
                
                textarea.placeholder = placeholders[tempMarkerData.type] || 'Beschreibe diesen Punkt...';
                
                // Schwierigkeit anzeigen f√ºr Startpunkt und Route
                if (['startpoint', 'route'].includes(tempMarkerData.type)) {
                    document.getElementById('difficultyGroup').style.display = 'block';
                } else {
                    document.getElementById('difficultyGroup').style.display = 'none';
                }
            }
        }

        function closeModal() {
            document.getElementById('markerModal').classList.remove('active');
            
            // Wenn Route-Modus aktiv ist und noch nicht beendet wurde, NICHT zur√ºcksetzen
            if (routeMode) {
                console.log('Modal geschlossen, Route-Modus bleibt aktiv');
            } else {
                tempMarkerData = null;
                waitingForType = false;
                clickedPosition = null;
            }
        }

        function autoExpandTextarea(e) {
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
        }

        function addMarkerToGroup() {
            const name = document.getElementById('markerName').value.trim();
            const difficulty = document.getElementById('markerDifficulty').value;
            const description = document.getElementById('markerDescription').value;
            
            if (!name) {
                alert('‚ö†Ô∏è Bitte gib einen Namen ein!');
                return;
            }

            if (!groupMode) {
                // Erste Strecke/Punkt - Gruppe initialisieren
                const itemData = {
                    name: name,
                    type: tempMarkerData.type,
                    difficulty: difficulty,
                    description: description
                };
                
                if (tempMarkerData.isRoute) {
                    itemData.points = tempMarkerData.points;
                    itemData.isRoute = true;
                    
                    // Strecken-Modus beenden
                    routeMode = false;
                    routePoints = [];
                    if (tempPolyline) {
                        map.removeLayer(tempPolyline);
                        tempPolyline = null;
                    }
                    // Punkt-Marker entfernen
                    tempRouteMarkers.forEach(marker => map.removeLayer(marker));
                    tempRouteMarkers = [];
                } else {
                    itemData.lat = tempMarkerData.lat;
                    itemData.lng = tempMarkerData.lng;
                }

                currentGroup = {
                    id: Date.now(),
                    name: name, // Initial der Name des ersten Elements
                    items: [itemData]
                };
                groupMode = true;
                
                closeModal();
                tempMarkerData = null;
                
                // Gruppen-√úbersichts-Modal √∂ffnen
                openGroupOverviewModal();
                
            } else {
                // Weiterer Marker zur Gruppe
                const itemData = {
                    name: name,
                    type: tempMarkerData.type,
                    difficulty: difficulty,
                    description: description
                };
                
                if (tempMarkerData.isRoute) {
                    itemData.points = tempMarkerData.points;
                    itemData.isRoute = true;
                    
                    // Strecken-Modus beenden
                    routeMode = false;
                    routePoints = [];
                    if (tempPolyline) {
                        map.removeLayer(tempPolyline);
                        tempPolyline = null;
                    }
                    // Punkt-Marker entfernen
                    tempRouteMarkers.forEach(marker => map.removeLayer(marker));
                    tempRouteMarkers = [];
                } else {
                    itemData.lat = tempMarkerData.lat;
                    itemData.lng = tempMarkerData.lng;
                }
                
                currentGroup.items.push(itemData);
                
                closeModal();
                tempMarkerData = null;
                
                // Gruppen-√úbersichts-Modal √∂ffnen/aktualisieren
                openGroupOverviewModal();
            }
        }

        function openGroupOverviewModal() {
            if (!currentGroup) return;

            // Gruppennamen setzen
            document.getElementById('groupNameInput').value = currentGroup.name;

            // Items-Liste aufbauen
            updateGroupItemsList();

            // Modal √∂ffnen
            document.getElementById('groupOverviewModal').classList.add('active');
        }

        function updateGroupItemsList() {
            if (!currentGroup) return;

            const container = document.getElementById('groupItemsList');
            const count = document.getElementById('groupItemCountModal');
            
            count.textContent = currentGroup.items.length;

            if (currentGroup.items.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">Noch keine Elemente</p>';
                return;
            }

            container.innerHTML = currentGroup.items.map((item, index) => {
                const typeConfig = markerTypes[item.type];
                let coordInfo = '';
                
                if (item.isRoute) {
                    coordInfo = `üìè Strecke mit ${item.points.length} Wegpunkten`;
                } else {
                    coordInfo = `üìç ${item.lat.toFixed(5)}, ${item.lng.toFixed(5)}`;
                }

                return `
                    <div class="group-item-card">
                        <div class="group-item-header">
                            <span class="group-item-title">${index + 1}. ${item.name}</span>
                            <span class="group-item-icon">${typeConfig.icon}</span>
                        </div>
                        <div class="group-item-type">${typeConfig.name}${item.difficulty ? ' ‚Ä¢ ' + getDifficultyLabel(item.difficulty) : ''}</div>
                        <div class="group-item-coords">${coordInfo}</div>
                        ${item.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">${item.description}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showGroupOnMap() {
            if (!currentGroup || currentGroup.items.length === 0) {
                alert('‚ö†Ô∏è Keine Elemente im Tourpaket!');
                return;
            }

            // Alte Vorschau-Marker entfernen
            clearGroupPreview();

            // Alle Elemente auf der Karte anzeigen
            const allPoints = [];

            currentGroup.items.forEach((item, index) => {
                const typeConfig = markerTypes[item.type];
                
                if (item.isRoute && item.points) {
                    // Strecke als Linie zeichnen
                    const color = difficultyColors[item.difficulty] || '#8b5cf6';
                    const polyline = L.polyline(item.points, {
                        color: color,
                        weight: 5,
                        opacity: 0.8,
                        dashArray: '10, 5' // Gestrichelt f√ºr Vorschau
                    }).addTo(map);
                    
                    polyline.bindPopup(`
                        <div style="min-width: 150px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: ${color};">
                                ${typeConfig.icon} ${item.name}
                            </h4>
                            <p style="margin: 0; font-size: 0.85rem;">
                                <strong>Typ:</strong> ${typeConfig.name}<br>
                                ${item.difficulty ? `<strong>Schwierigkeit:</strong> ${getDifficultyLabel(item.difficulty)}<br>` : ''}
                                <strong>Wegpunkte:</strong> ${item.points.length}
                            </p>
                        </div>
                    `);
                    
                    tempGroupPreviewMarkers.push(polyline);
                    item.points.forEach(p => allPoints.push(p));
                } else {
                    // Einzelner Marker
                    const markerIcon = L.divIcon({
                        html: `<div style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">${typeConfig.icon}</div>`,
                        className: 'custom-marker',
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    });

                    const marker = L.marker([item.lat, item.lng], { icon: markerIcon }).addTo(map);
                    
                    marker.bindPopup(`
                        <div style="min-width: 150px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: ${typeConfig.color};">
                                ${typeConfig.icon} ${item.name}
                            </h4>
                            <p style="margin: 0; font-size: 0.85rem;">
                                <strong>Typ:</strong> ${typeConfig.name}<br>
                                ${item.difficulty ? `<strong>Schwierigkeit:</strong> ${getDifficultyLabel(item.difficulty)}<br>` : ''}
                                üìç ${item.lat.toFixed(5)}, ${item.lng.toFixed(5)}
                            </p>
                        </div>
                    `);
                    
                    tempGroupPreviewMarkers.push(marker);
                    allPoints.push([item.lat, item.lng]);
                }
            });

            // Karte auf alle Punkte zoomen
            if (allPoints.length > 0) {
                const bounds = L.latLngBounds(allPoints);
                map.fitBounds(bounds, { 
                    padding: [50, 50],
                    maxZoom: 15
                });
            }

            // Modal minimieren f√ºr bessere Sicht
            minimizeGroupModal();
        }

        function clearGroupPreview() {
            // Alle tempor√§ren Tourpaket-Vorschau-Marker entfernen
            tempGroupPreviewMarkers.forEach(item => {
                map.removeLayer(item);
            });
            tempGroupPreviewMarkers = [];
        }

        function minimizeGroupModal() {
            const modalContent = document.getElementById('groupModalContent');
            const toggleBtn = document.getElementById('minimizeToggleBtn');
            const modal = document.getElementById('groupOverviewModal');
            
            modalContent.classList.add('minimized');
            modal.style.backgroundColor = 'transparent'; // Hintergrund durchsichtig
            toggleBtn.textContent = 'üìã'; // Icon √§ndern zu "maximieren"
        }

        function maximizeGroupModal() {
            const modalContent = document.getElementById('groupModalContent');
            const toggleBtn = document.getElementById('minimizeToggleBtn');
            const modal = document.getElementById('groupOverviewModal');
            
            modalContent.classList.remove('minimized');
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)'; // Hintergrund wieder normal
            toggleBtn.textContent = 'üìê'; // Icon √§ndern zu "minimieren"
        }

        function toggleMinimizeGroupModal() {
            const modalContent = document.getElementById('groupModalContent');
            
            if (modalContent.classList.contains('minimized')) {
                maximizeGroupModal();
            } else {
                minimizeGroupModal();
            }
        }

        function closeGroupOverviewModal() {
            // Tourpaket-Namen aus Input aktualisieren
            if (currentGroup) {
                const newName = document.getElementById('groupNameInput').value.trim();
                if (newName) {
                    currentGroup.name = newName;
                }
            }
            
            // Tourpaket-Vorschau entfernen
            clearGroupPreview();
            
            // Modal maximieren falls minimiert
            maximizeGroupModal();
            
            document.getElementById('groupOverviewModal').classList.remove('active');
            
            // Sidebar-UI aktualisieren
            updateGroupUI();
        }

        function addAnotherToGroup() {
            if (!groupMode || !currentGroup) {
                alert('‚ö†Ô∏è Kein aktives Tourpaket vorhanden!');
                return;
            }

            // Tourpaket-Namen speichern
            const newName = document.getElementById('groupNameInput').value.trim();
            if (newName) {
                currentGroup.name = newName;
            }

            // Tourpaket-Modal schlie√üen
            document.getElementById('groupOverviewModal').classList.remove('active');
            
            // Typ-Auswahl-Modal √∂ffnen
            waitingForType = true;
            showTypeSelectionModal();
        }

        function sendGroupFromModal() {
            if (!currentGroup || currentGroup.items.length === 0) {
                alert('‚ö†Ô∏è Keine Elemente im Tourpaket!');
                return;
            }

            // Tourpaket-Namen aktualisieren
            const newName = document.getElementById('groupNameInput').value.trim();
            if (newName) {
                currentGroup.name = newName;
            }

            // Direkt senden ohne Email-Best√§tigung
            sendGroupEmail();
        }

        function addToCurrentGroup() {
            if (!groupMode || !currentGroup) {
                alert('‚ö†Ô∏è Kein aktives Tourpaket vorhanden!');
                return;
            }
            
            // Tourpaket-√úbersichts-Modal √∂ffnen
            openGroupOverviewModal();
        }

        function updateGroupUI() {
            if (groupMode && currentGroup) {
                document.getElementById('activeGroupInfo').style.display = 'block';
                document.getElementById('activeGroupNameSidebar').textContent = currentGroup.name;
                document.getElementById('groupItemCount').textContent = currentGroup.items.length;
            } else {
                document.getElementById('activeGroupInfo').style.display = 'none';
            }
        }

        function finishGroup() {
            if (!groupMode || !currentGroup) {
                alert('‚ö†Ô∏è Keine aktive Gruppe vorhanden!');
                return;
            }
            
            if (!confirm(`Gruppe "${currentGroup.name}" mit ${currentGroup.items.length} Element(en) abschlie√üen und per E-Mail senden?`)) {
                return;
            }
            
            sendGroupEmail();
        }

        function sendGroupEmail() {
            if (!currentGroup || currentGroup.items.length === 0) {
                alert('‚ö†Ô∏è Keine Elemente im Tourpaket!');
                return;
            }

            // Tourpaket als Vorschlag zu Firebase senden
            const groupSuggestion = {
                id: Date.now(),
                name: currentGroup.name,
                type: 'tourpaket',
                items: currentGroup.items.map(item => {
                    // Konvertiere Points zu String f√ºr Firebase
                    if (item.isRoute && item.points) {
                        return {
                            ...item,
                            pointsString: item.points.map(p => `${p[0]},${p[1]}`).join('|'),
                            points: null // Entferne verschachteltes Array
                        };
                    }
                    return item;
                }),
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            if (db) {
                db.collection('suggestions').add(groupSuggestion)
                    .then(() => {
                        // Admin benachrichtigen
                        sendTourpaketNotification(groupSuggestion);
                        
                        // Gruppen-Modal schlie√üen
                        document.getElementById('groupOverviewModal').classList.remove('active');
                        clearGroupPreview();
                        
                        // Gruppe zur√ºcksetzen
                        currentGroup = null;
                        groupMode = false;
                        updateGroupUI();
                        
                        alert('‚úÖ Tourpaket wurde gesendet!\n\nDer Admin wird es pr√ºfen und auf der Karte ver√∂ffentlichen.');
                    })
                    .catch(error => {
                        console.error('Fehler beim Senden:', error);
                        // Trotzdem schlie√üen
                        document.getElementById('groupOverviewModal').classList.remove('active');
                        clearGroupPreview();
                        currentGroup = null;
                        groupMode = false;
                        updateGroupUI();
                        alert('‚ùå Fehler beim Senden. Wurde lokal gespeichert.');
                    });
            } else {
                // Offline-Fallback
                markerSuggestions.push(groupSuggestion);
                saveSuggestionsToStorage();
                
                document.getElementById('groupOverviewModal').classList.remove('active');
                clearGroupPreview();
                currentGroup = null;
                groupMode = false;
                updateGroupUI();
                alert('‚ö†Ô∏è Offline-Modus: Tourpaket lokal gespeichert.\n\nBitte sp√§ter nochmal versuchen wenn du online bist.');
            }
        }

        function sendMarkerEmail() {
            if (!tempMarkerData) return;

            const type = tempMarkerData.type;
            const name = document.getElementById('markerName').value.trim();
            const difficulty = document.getElementById('markerDifficulty').value;
            const description = document.getElementById('markerDescription').value;
            const typeConfig = markerTypes[type];

            if (!name) {
                alert('‚ö†Ô∏è Bitte gib einen Namen ein!');
                return;
            }

            // Vorschlag erstellen
            const suggestion = {
                id: Date.now(),
                name: name,
                type: type,
                difficulty: difficulty,
                description: description,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            if (tempMarkerData.isRoute) {
                suggestion.isRoute = true;
                // Konvertiere Points zu String f√ºr Firebase (keine nested arrays)
                suggestion.pointsString = tempMarkerData.points.map(p => `${p[0]},${p[1]}`).join('|');
                
                // Strecken-Modus beenden und aufr√§umen
                routeMode = false;
                routePoints = [];
                if (tempPolyline) {
                    map.removeLayer(tempPolyline);
                    tempPolyline = null;
                }
                // Punkt-Marker entfernen
                tempRouteMarkers.forEach(marker => map.removeLayer(marker));
                tempRouteMarkers = [];
            } else {
                suggestion.lat = tempMarkerData.lat;
                suggestion.lng = tempMarkerData.lng;
            }

            // Zu Firebase hochladen
            if (db) {
                db.collection('suggestions').add(suggestion)
                    .then(() => {
                        closeModal();
                        tempMarkerData = null;
                        alert('‚úÖ Dein Vorschlag wurde gesendet!\n\nDer Admin wird ihn pr√ºfen und auf der Karte ver√∂ffentlichen.');
                        
                        // Admin per Email benachrichtigen
                        sendAdminNotification(suggestion);
                    })
                    .catch(error => {
                        console.error('Fehler beim Senden:', error);
                        closeModal();
                        tempMarkerData = null;
                        alert('‚ùå Fehler beim Senden. Wurde lokal gespeichert.');
                    });
            } else {
                // Offline-Fallback: Lokal speichern
                markerSuggestions.push(suggestion);
                saveSuggestionsToStorage();
                closeModal();
                tempMarkerData = null;
                alert('‚ö†Ô∏è Offline-Modus: Vorschlag lokal gespeichert.\n\nBitte sp√§ter nochmal versuchen wenn du online bist.');
            }
        }

        function sendAdminNotification(suggestion) {
            // Erstelle Email-Link
            const typeConfig = markerTypes[suggestion.type];
            const subject = encodeURIComponent(`üîî Neuer Marker-Vorschlag: ${suggestion.name}`);
            
            let body = `Hallo Admin,\n\n`;
            body += `Ein neuer Marker-Vorschlag wurde eingereicht:\n\n`;
            body += `üìç Name: ${suggestion.name}\n`;
            body += `üè∑Ô∏è Typ: ${typeConfig.name} ${typeConfig.icon}\n`;
            
            if (suggestion.isRoute) {
                const pointCount = suggestion.pointsString ? suggestion.pointsString.split('|').length : 0;
                body += `üöµ Strecke mit ${pointCount} Wegpunkten\n`;
            } else {
                body += `üìç Koordinaten: ${suggestion.lat}, ${suggestion.lng}\n`;
            }
            
            if (suggestion.difficulty) {
                body += `‚ö° Schwierigkeit: ${getDifficultyLabel(suggestion.difficulty)}\n`;
            }
            
            if (suggestion.description) {
                body += `üìù Beschreibung: ${suggestion.description}\n`;
            }
            
            body += `\nüìÖ Eingereicht: ${new Date(suggestion.createdAt).toLocaleString('de-DE')}\n\n`;
            body += `Bitte pr√ºfe den Vorschlag im Admin-Bereich deiner Website.\n\n`;
            body += `Deine MTB-Trails Plattform`;
            
            const mailtoLink = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${encodeURIComponent(body)}`;
            
            // √ñffne Email-Client (nur wenn ADMIN_EMAIL gesetzt ist)
            if (ADMIN_EMAIL && ADMIN_EMAIL !== '') {
                console.log('üìß Email-Benachrichtigung vorbereitet f√ºr:', ADMIN_EMAIL);
                // √ñffne mailto in neuem kleinen Fenster (weniger st√∂rend)
                window.open(mailtoLink, '_blank', 'width=600,height=400');
            }
        }

        function sendTourpaketNotification(tourpaket) {
            const subject = encodeURIComponent(`üîî Neues Tourpaket: ${tourpaket.name}`);
            
            let body = `Hallo Admin,\n\n`;
            body += `Ein neues Tourpaket wurde eingereicht:\n\n`;
            body += `üì¶ Name: ${tourpaket.name}\n`;
            body += `üìç Anzahl Elemente: ${tourpaket.items.length}\n\n`;
            body += `Enthaltene Elemente:\n`;
            
            tourpaket.items.forEach((item, idx) => {
                const typeConfig = markerTypes[item.type];
                body += `${idx + 1}. ${typeConfig.icon} ${item.name}\n`;
            });
            
            body += `\nüìÖ Eingereicht: ${new Date(tourpaket.createdAt).toLocaleString('de-DE')}\n\n`;
            body += `Bitte pr√ºfe das Tourpaket im Admin-Bereich deiner Website.\n\n`;
            body += `Deine MTB-Trails Plattform`;
            
            const mailtoLink = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${encodeURIComponent(body)}`;
            
            if (ADMIN_EMAIL && ADMIN_EMAIL !== '') {
                console.log('üìß Tourpaket-Benachrichtigung vorbereitet');
                window.open(mailtoLink, '_blank', 'width=600,height=400');
            }
        }

        function addMarkerToMap(markerData) {
            const typeConfig = markerTypes[markerData.type];
            const zoom = map.getZoom();

            if (markerData.isRoute && markerData.points) {
                // Strecke als Linie zeichnen
                const color = difficultyColors[markerData.difficulty];
                
                // Linienbreite abh√§ngig vom Zoom
                let weight = 3;
                if (zoom >= 10) weight = 4;
                if (zoom >= 13) weight = 5;
                if (zoom < 10) weight = 2;
                
                const polyline = L.polyline(markerData.points, {
                    color: color,
                    weight: weight,
                    opacity: zoom < 10 ? 0.5 : 0.8
                }).addTo(map);

                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="color: ${color}; margin: 0 0 10px 0;">${typeConfig.icon} ${markerData.name}</h3>
                        <p><strong>Typ:</strong> ${typeConfig.name}</p>
                        <p><strong>Schwierigkeit:</strong> ${getDifficultyLabel(markerData.difficulty)}</p>
                        <p><strong>L√§nge:</strong> ${markerData.points.length} Wegpunkte</p>
                        ${markerData.description ? `<p><strong>Beschreibung:</strong><br>${markerData.description}</p>` : ''}
                        ${markerData.groupId ? `<p style="background-color: ${typeConfig.color}; color: white; padding: 0.3rem; border-radius: 3px; font-size: 0.85rem;">üîó Tourpaket: ${markerData.groupName}</p>` : ''}
                    </div>
                `;
                polyline.bindPopup(popupContent);
                polyline.markerId = markerData.id;
                
                // Click-Event f√ºr Tourpaket-Hervorhebung
                if (markerData.groupId) {
                    polyline.on('click', () => highlightTourpaket(markerData.groupId));
                }
            } else {
                // Einzelner Marker - Gr√∂√üe und Sichtbarkeit abh√§ngig vom Zoom
                let iconSize, fontSize;
                
                if (zoom < 10) {
                    // Sehr weit raus: Kleine Cluster-Punkte
                    fontSize = '0.8rem';
                    iconSize = [12, 12];
                } else if (zoom < 13) {
                    // Mittlerer Zoom: Mittelgro√üe Icons
                    fontSize = '1.5rem';
                    iconSize = [25, 25];
                } else {
                    // Nah dran: Volle Gr√∂√üe
                    fontSize = '2rem';
                    iconSize = [30, 30];
                }

                const customIcon = L.divIcon({
                    html: `<div style="font-size: ${fontSize};">${typeConfig.icon}</div>`,
                    className: 'custom-marker',
                    iconSize: iconSize,
                    iconAnchor: [iconSize[0]/2, iconSize[1]]
                });

                const marker = L.marker([markerData.lat, markerData.lng], { icon: customIcon }).addTo(map);
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="color: ${typeConfig.color}; margin: 0 0 10px 0;">${typeConfig.icon} ${markerData.name}</h3>
                        <p><strong>Typ:</strong> ${typeConfig.name}</p>
                        <p><strong>Schwierigkeit:</strong> ${getDifficultyLabel(markerData.difficulty)}</p>
                        ${markerData.description ? `<p><strong>Beschreibung:</strong><br>${markerData.description}</p>` : ''}
                        <p style="font-size: 0.85rem; color: #666;">üìç ${markerData.lat.toFixed(5)}, ${markerData.lng.toFixed(5)}</p>
                        ${markerData.groupId ? `<p style="background-color: ${typeConfig.color}; color: white; padding: 0.3rem; border-radius: 3px; font-size: 0.85rem;">üîó Tourpaket: ${markerData.groupName}</p>` : ''}
                    </div>
                `;
                marker.bindPopup(popupContent);
                marker.markerId = markerData.id;
                
                // Click-Event f√ºr Tourpaket-Hervorhebung
                if (markerData.groupId) {
                    marker.on('click', () => highlightTourpaket(markerData.groupId));
                }
            }
        }

        function updateMarkerSizes() {
            // Alle Marker neu zeichnen mit angepasster Gr√∂√üe
            reloadMap();
        }

        function highlightTourpaket(groupId) {
            // Alte Hervorhebungen entfernen
            clearTourpaketHighlight();

            // Alle Marker mit dieser groupId finden
            const groupMarkers = markers.filter(m => m.groupId === groupId);
            
            if (groupMarkers.length === 0) return;

            const positions = [];

            groupMarkers.forEach(markerData => {
                if (markerData.isRoute && markerData.points) {
                    // F√ºr Strecken: Mittelpunkt nehmen
                    const midIndex = Math.floor(markerData.points.length / 2);
                    positions.push(markerData.points[midIndex]);
                } else {
                    // F√ºr Punkte: Position direkt
                    positions.push([markerData.lat, markerData.lng]);
                    
                    // Puls-Ring um jeden Punkt
                    const circle = L.circle([markerData.lat, markerData.lng], {
                        color: '#d97316',
                        fillColor: '#d97316',
                        fillOpacity: 0.1,
                        weight: 3,
                        radius: 50, // 50 Meter Radius
                        className: 'tourpaket-highlight-pulse'
                    }).addTo(map);
                    
                    tourpaketHighlightLayers.push(circle);
                }
            });

            // Verbindungslinien zwischen den Punkten zeichnen
            if (positions.length > 1) {
                const connectionLine = L.polyline(positions, {
                    color: '#d97316',
                    weight: 2,
                    opacity: 0.6,
                    dashArray: '8, 8'
                }).addTo(map);
                
                tourpaketHighlightLayers.push(connectionLine);
            }

            // Nach 5 Sekunden Hervorhebung entfernen
            setTimeout(() => {
                clearTourpaketHighlight();
            }, 5000);
        }

        function clearTourpaketHighlight() {
            tourpaketHighlightLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            tourpaketHighlightLayers = [];
        }

        function getDifficultyLabel(d) {
            const labels = { easy: 'üü¢ Leicht', medium: 'üîµ Mittel', hard: 'üî¥ Schwer', extreme: '‚ö´ Extrem' };
            return labels[d] || d;
        }

        function updateMarkerList() {
            const container = document.getElementById('markerListContainer');
            
            if (markers.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">Noch keine Marker</p>';
                return;
            }

            // Sortiere nach Erstellungsdatum (neueste zuerst) und nimm die ersten 5
            const recentMarkers = [...markers]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);

            container.innerHTML = recentMarkers.map(m => {
                const t = markerTypes[m.type];
                const coordDisplay = m.isRoute 
                    ? `${m.points.length} Wegpunkte` 
                    : `üìç ${m.lat.toFixed(4)}, ${m.lng.toFixed(4)}`;
                
                const groupBadge = m.groupId ? `<div class="marker-group-badge">üîó ${m.groupName}</div>` : '';
                
                // Zeitstempel anzeigen
                const timeAgo = getTimeAgo(m.createdAt);
                
                return `
                    <div class="marker-item" onclick="focusMarker(${m.isRoute ? 'null' : m.lat}, ${m.isRoute ? 'null' : m.lng}, ${m.isRoute}, ${m.id})">
                        <div class="marker-item-header">
                            <span class="marker-item-title">${m.name}</span>
                            <span class="marker-item-type">${t.icon}</span>
                        </div>
                        <div class="marker-item-coords">${coordDisplay}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.3rem;">üïê ${timeAgo}</div>
                        ${groupBadge}
                    </div>
                `;
            }).join('');
            
            if (markers.length > 5) {
                container.innerHTML += `<p style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 1rem;">... und ${markers.length - 5} weitere Marker</p>`;
            }
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Unbekannt';
            
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Gerade eben';
            if (diffMins < 60) return `vor ${diffMins} Min`;
            if (diffHours < 24) return `vor ${diffHours} Std`;
            if (diffDays < 7) return `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            return past.toLocaleDateString('de-DE');
        }

        function focusMarker(lat, lng, isRoute, id) {
            if (isRoute) {
                const marker = markers.find(m => m.id === id);
                if (marker && marker.points) {
                    const bounds = L.latLngBounds(marker.points);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } else {
                map.setView([lat, lng], 15);
            }
        }

        function deleteMarker(id) {
            console.log('üóëÔ∏è deleteMarker aufgerufen f√ºr ID:', id);
            
            if (!confirm('Marker wirklich l√∂schen?\n\n‚ö†Ô∏è Nur als Admin: Dies l√∂scht den Marker dauerhaft!')) {
                console.log('‚ùå L√∂schen abgebrochen');
                return;
            }
            
            const marker = markers.find(m => m.id === id);
            console.log('üìç Zu l√∂schender Marker:', marker);
            
            if (!marker) {
                console.error('‚ùå Marker nicht gefunden!');
                return;
            }
            
            // SOFORT aus lokalem Array entfernen
            const vorher = markers.length;
            markers = markers.filter(m => m.id !== id);
            console.log(`üìä Marker Array: ${vorher} ‚Üí ${markers.length}`);
            
            // Alle UIs sofort aktualisieren
            saveMarkersToStorage();
            reloadMap();
            updateMarkerList();
            
            // Admin-Liste SOFORT und DIREKT aktualisieren
            const adminDashboard = document.getElementById('adminDashboard');
            const adminMarkerList = document.getElementById('adminMarkerList');
            
            console.log('üîç Admin Dashboard aktiv?', adminDashboard?.classList.contains('active'));
            console.log('üîç Admin Marker List gefunden?', !!adminMarkerList);
            
            if (adminDashboard && adminDashboard.classList.contains('active')) {
                console.log('üîÑ Rufe updateAdminMarkerList auf...');
                updateAdminMarkerList();
                console.log('‚úÖ updateAdminMarkerList abgeschlossen');
                
                // FORCE UPDATE - setze totalMarkerCount nochmal
                const countElement = document.getElementById('totalMarkerCount');
                if (countElement) {
                    countElement.textContent = markers.length;
                    console.log('‚úÖ totalMarkerCount aktualisiert:', markers.length);
                }
            }
            
            // Auch aus Firebase l√∂schen (im Hintergrund)
            if (db && marker.firebaseId) {
                console.log('üî• L√∂sche aus Firebase:', marker.firebaseId);
                db.collection('markers').doc(marker.firebaseId).delete()
                    .then(() => {
                        console.log('‚úÖ Firebase-L√∂schung erfolgreich');
                    })
                    .catch(error => {
                        console.error('‚ùå Firebase L√∂sch-Fehler:', error);
                    });
            } else {
                console.warn('‚ö†Ô∏è Kein Firebase ID - nur lokal gel√∂scht');
            }
        }

        function reloadMap() {
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });
            markers.forEach(m => addMarkerToMap(m));
        }

        function saveMarkersToStorage() {
            localStorage.setItem('mtb_markers', JSON.stringify(markers));
        }

        function loadMarkersFromStorage() {
            // Erst von Firebase laden (f√ºr alle User gleich)
            if (db) {
                console.log('üî• Starte Firebase Echtzeit-Listener f√ºr Marker...');
                
                // ECHTZEIT-LISTENER: Aktualisiert automatisch bei √Ñnderungen!
                db.collection('markers')
                    .onSnapshot((snapshot) => {
                        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        console.log('üîÑ MARKER-√ÑNDERUNG ERKANNT VON FIREBASE');
                        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        console.log('üìä Snapshot-Gr√∂√üe:', snapshot.size);
                        console.log('üìä Vorherige Marker-Anzahl:', markers.length);
                        
                        markers = [];
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            console.log('üìÑ Lade Marker:', doc.id, '-', data.name);
                            
                            // Konvertiere pointsString zur√ºck zu Array
                            if (data.isRoute && data.pointsString) {
                                data.points = data.pointsString.split('|').map(p => {
                                    const [lat, lng] = p.split(',').map(parseFloat);
                                    return [lat, lng];
                                });
                            }
                            
                            markers.push({
                                firebaseId: doc.id,
                                ...data
                            });
                        });
                        
                        console.log('‚úÖ Neue Marker-Anzahl:', markers.length);
                        console.log('üîÑ Aktualisiere UI...');
                        
                        // Karte komplett neu laden
                        reloadMap();
                        updateMarkerList();
                        
                        // Admin-Liste auch aktualisieren wenn offen
                        const adminDashboard = document.getElementById('adminDashboard');
                        if (adminDashboard && adminDashboard.classList.contains('active')) {
                            console.log('üîÑ Admin-Dashboard ist offen - aktualisiere Liste');
                            updateAdminMarkerList();
                        }
                        
                        // Auch lokal speichern als Backup
                        saveMarkersToStorage();
                        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    }, (error) => {
                        console.error('‚ùå Firebase Echtzeit-Listener Fehler:', error);
                        console.error('‚ùå Error Code:', error.code);
                        console.error('‚ùå Error Message:', error.message);
                        // Fallback: Von localStorage laden
                        loadFromLocalStorage();
                    });
            } else {
                console.warn('‚ö†Ô∏è Kein Firebase - lade von localStorage');
                // Offline: Von localStorage laden
                loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            const stored = localStorage.getItem('mtb_markers');
            if (stored) {
                markers = JSON.parse(stored);
                markers.forEach(m => addMarkerToMap(m));
                updateMarkerList();
                console.log(`üìÇ ${markers.length} Marker von localStorage geladen`);
            }
        }

        function exportMarkers() {
            if (markers.length === 0) {
                alert('‚ö†Ô∏è Keine Marker zum Exportieren!');
                return;
            }

            let csv = 'name,coordinates,type,difficulty,description,groupId,groupName\n';
            markers.forEach(m => {
                let coords;
                if (m.isRoute && m.points) {
                    coords = m.points.map(p => `${p[0]}/${p[1]}`).join('|');
                } else {
                    coords = `${m.lat},${m.lng}`;
                }
                csv += `"${m.name}","${coords}",${m.type},${m.difficulty},"${m.description || ''}",${m.groupId || ''},${m.groupName || ''}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mtb-markers-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Marker als CSV exportiert!');
        }

        function parseCoordinate(value) {
            if (typeof value === 'number') return value;
            let cleaned = value.replace(/["'\s]/g, '');
            const dotCount = (cleaned.match(/\./g) || []).length;
            if (dotCount > 1) {
                const parts = cleaned.split('.');
                const decimals = parts.pop();
                cleaned = parts.join('') + '.' + decimals;
            }
            cleaned = cleaned.replace(',', '.');
            return parseFloat(cleaned);
        }

        function importMarkersCSV(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());

                    if (lines.length === 0) throw new Error('CSV-Datei ist leer');

                    const dataLines = lines.slice(1);
                    if (dataLines.length === 0) throw new Error('CSV enth√§lt keine Daten (nur Header)');

                    const confirmed = confirm(
                        `${dataLines.length} Zeilen gefunden.\n\n` +
                        '‚ö†Ô∏è ACHTUNG: Alle bestehenden Marker werden ERSETZT!\n\nFortfahren?'
                    );
                    if (!confirmed) return;

                    markers = [];
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];

                    dataLines.forEach((line, index) => {
                        const lineNum = index + 2;
                        try {
                            const separator = line.includes('\t') ? '\t' : ',';
                            let values;
                            if (separator === '\t') {
                                values = line.split('\t').map(v => v.trim());
                            } else {
                                values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                                if (values) values = values.map(v => v.replace(/^"|"$/g, '').trim());
                            }

                            if (!values || values.length < 5) throw new Error(`Zu wenig Spalten`);

                            const name = values[0];
                            const coordsStr = values[1];
                            const type = values[2].toLowerCase().trim();
                            const difficulty = values[3].toLowerCase().trim();
                            const description = values[4] || '';
                            const groupId = values[5] || null;
                            const groupName = values[6] || null;

                            if (!name) throw new Error('Name fehlt');
                            if (!markerTypes[type]) throw new Error(`Ung√ºltiger Typ: "${type}"`);

                            const validDifficulties = ['easy', 'medium', 'hard', 'extreme'];
                            if (!validDifficulties.includes(difficulty)) throw new Error(`Ung√ºltige Schwierigkeit`);

                            // Pr√ºfen ob Strecke oder Punkt
                            if (coordsStr.includes('|')) {
                                // Strecke
                                const points = coordsStr.split('|').map(p => {
                                    const [lat, lng] = p.split('/').map(c => parseCoordinate(c));
                                    if (isNaN(lat) || isNaN(lng)) throw new Error('Ung√ºltige Koordinaten in Strecke');
                                    return [lat, lng];
                                });

                                markers.push({
                                    id: Date.now() + index,
                                    name, type, difficulty, description,
                                    isRoute: true,
                                    points: points,
                                    groupId: groupId,
                                    groupName: groupName,
                                    createdAt: new Date().toISOString()
                                });
                            } else {
                                // Einzelpunkt
                                const coords = coordsStr.split(',');
                                const lat = parseCoordinate(coords[0]);
                                const lng = parseCoordinate(coords[1]);

                                if (isNaN(lat) || lat < -90 || lat > 90) throw new Error(`Ung√ºltiger Breitengrad`);
                                if (isNaN(lng) || lng < -180 || lng > 180) throw new Error(`Ung√ºltiger L√§ngengrad`);

                                markers.push({
                                    id: Date.now() + index,
                                    name, lat, lng, type, difficulty, description,
                                    groupId: groupId,
                                    groupName: groupName,
                                    createdAt: new Date().toISOString()
                                });
                            }
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            errors.push(`Zeile ${lineNum}: ${error.message}`);
                        }
                    });

                    if (successCount > 0) {
                        saveMarkersToStorage();
                        reloadMap();
                        updateMarkerList();
                    }

                    let message = `‚úÖ ${successCount} Marker erfolgreich importiert!`;
                    if (errorCount > 0) {
                        message += `\n\n‚ö†Ô∏è ${errorCount} Zeilen √ºbersprungen:\n\n`;
                        message += errors.slice(0, 5).join('\n');
                        if (errors.length > 5) message += `\n... und ${errors.length - 5} weitere`;
                    }
                    alert(message);
                } catch (error) {
                    alert('‚ùå Fehler beim Importieren:\n' + error.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        let searchTimeout;

        function handleSearchInput(e) {
            const query = e.target.value.trim();
            
            // Debounce - warte 300ms nach letzter Eingabe
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                closeSearchDropdown();
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }

        async function performSearch(query) {
            const results = [];

            // 1. Koordinaten-Suche
            const coordMatch = query.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
            if (coordMatch) {
                const lat = parseFloat(coordMatch[1]);
                const lng = parseFloat(coordMatch[2]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    results.push({
                        type: 'coordinates',
                        icon: 'üìç',
                        title: 'Koordinaten',
                        subtitle: `${lat.toFixed(5)}, ${lng.toFixed(5)}`,
                        lat: lat,
                        lng: lng,
                        zoom: 15
                    });
                }
            }

            // 2. Eigene Marker durchsuchen
            const lowerQuery = query.toLowerCase();
            const matchingMarkers = markers.filter(m =>
                m.name.toLowerCase().includes(lowerQuery) ||
                (m.description && m.description.toLowerCase().includes(lowerQuery))
            );

            matchingMarkers.slice(0, 5).forEach(m => {
                const typeConfig = markerTypes[m.type];
                results.push({
                    type: 'marker',
                    icon: typeConfig.icon,
                    title: m.name,
                    subtitle: typeConfig.name,
                    markerId: m.id,
                    isRoute: m.isRoute,
                    lat: m.lat,
                    lng: m.lng
                });
            });

            // 3. Geocoding-Suche (St√§dte/Orte)
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'MTB-Trails-App'
                        }
                    }
                );

                const data = await response.json();

                data.forEach(result => {
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    // Icon basierend auf Typ
                    let icon = 'üìç';
                    if (result.type === 'city' || result.class === 'place') icon = 'üèôÔ∏è';
                    if (result.type === 'village') icon = 'üèòÔ∏è';
                    if (result.type === 'town') icon = 'üèòÔ∏è';
                    if (result.class === 'natural') icon = 'üèîÔ∏è';
                    if (result.class === 'leisure') icon = 'üå≤';

                    results.push({
                        type: 'location',
                        icon: icon,
                        title: result.name || result.display_name.split(',')[0],
                        subtitle: result.display_name,
                        lat: lat,
                        lng: lng,
                        zoom: 12
                    });
                });
            } catch (error) {
                console.error('Geocoding-Fehler:', error);
            }

            // Ergebnisse anzeigen
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const dropdown = document.getElementById('searchResultsDropdown');

            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div class="search-result-item" style="cursor: default;">
                        <div class="search-result-title" style="color: #999;">
                            Keine Ergebnisse gefunden
                        </div>
                    </div>
                `;
                dropdown.classList.add('active');
                return;
            }

            dropdown.innerHTML = results.map((result, index) => `
                <div class="search-result-item" onclick="selectSearchResult(${index})" data-result='${JSON.stringify(result).replace(/'/g, "&#39;")}'>
                    <span class="search-result-icon">${result.icon}</span>
                    <span style="display: inline-block; vertical-align: middle;">
                        <div class="search-result-title">
                            ${result.title}
                            ${result.type === 'marker' ? '<span class="search-result-type">Eigener Marker</span>' : ''}
                            ${result.type === 'location' ? '<span class="search-result-type" style="background-color: #3b82f6;">Ort</span>' : ''}
                            ${result.type === 'coordinates' ? '<span class="search-result-type" style="background-color: #d97316;">Koordinaten</span>' : ''}
                        </div>
                        <div class="search-result-subtitle">${result.subtitle || ''}</div>
                    </span>
                </div>
            `).join('');

            dropdown.classList.add('active');

            // Speichere Ergebnisse f√ºr selectSearchResult
            window.searchResults = results;
        }

        function selectSearchResult(index) {
            const result = window.searchResults[index];
            
            if (result.type === 'marker') {
                // Zu eigenem Marker zoomen
                if (result.isRoute) {
                    focusMarker(null, null, true, result.markerId);
                } else {
                    map.setView([result.lat, result.lng], 15);
                }
            } else {
                // Zu Koordinaten/Ort zoomen
                map.setView([result.lat, result.lng], result.zoom || 12);
                
                // Tempor√§ren Marker setzen
                const tempMarker = L.marker([result.lat, result.lng]).addTo(map);
                tempMarker.bindPopup(`
                    <div style="min-width: 150px;">
                        <h4 style="margin: 0 0 0.5rem 0;">${result.icon} ${result.title}</h4>
                        <p style="margin: 0; font-size: 0.85rem;">
                            ${result.lat.toFixed(5)}, ${result.lng.toFixed(5)}
                        </p>
                    </div>
                `).openPopup();

                // Marker nach 5 Sekunden entfernen
                setTimeout(() => {
                    map.removeLayer(tempMarker);
                }, 5000);
            }

            // Dropdown schlie√üen und Input leeren
            closeSearchDropdown();
            document.getElementById('searchInput').value = '';
        }

        function closeSearchDropdown() {
            document.getElementById('searchResultsDropdown').classList.remove('active');
        }

        // ==================== ADMIN FUNKTIONEN ====================

        function showAdminLogin() {
            document.getElementById('adminLoginOverlay').classList.add('active');
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminCodeInput').focus();
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginOverlay').classList.remove('active');
        }

        function checkAdminCode() {
            const code = document.getElementById('adminCodeInput').value;
            
            if (code === ADMIN_CODE) {
                isAdminLoggedIn = true;
                closeAdminLogin();
                openAdminDashboard();
            } else {
                alert('‚ùå Falscher Code!');
                document.getElementById('adminCodeInput').value = '';
            }
        }

        function openAdminDashboard() {
            loadSuggestionsFromStorage();
            document.getElementById('adminDashboard').classList.add('active');
            updateAdminDashboard();
            loadPageViewStats(); // Lade Besucher-Statistiken
        }

        function closeAdminDashboard() {
            document.getElementById('adminDashboard').classList.remove('active');
        }

        function switchAdminTab(tabName) {
            // Tabs umschalten
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'markers') {
                updateAdminMarkerList();
            } else if (tabName === 'stats') {
                // Content-Statistiken aktualisieren
                document.getElementById('statsMarkerCount').textContent = markers.length;
                document.getElementById('statsSuggestionCount').textContent = markerSuggestions.filter(s => s.status === 'pending').length;
                
                // Tourpakete z√§hlen (Marker mit groupId)
                const uniqueGroups = new Set(markers.filter(m => m.groupId).map(m => m.groupId));
                document.getElementById('statsTourpaketCount').textContent = uniqueGroups.size;
            }
        }

        function updateAdminDashboard() {
            // Vorschl√§ge aktualisieren
            const suggestionsList = document.getElementById('suggestionsList');
            const pendingSuggestions = markerSuggestions.filter(s => s.status === 'pending');
            
            document.getElementById('suggestionCount').textContent = pendingSuggestions.length;
            
            if (pendingSuggestions.length === 0) {
                suggestionsList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Keine neuen Vorschl√§ge</p>';
                return;
            }

            suggestionsList.innerHTML = pendingSuggestions.map(s => {
                // Tourpaket-Vorschlag
                if (s.type === 'tourpaket') {
                    return `
                        <div class="suggestion-card">
                            <div class="suggestion-header">
                                <div>
                                    <div class="suggestion-title">üì¶ Tourpaket: ${s.name}</div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">
                                        ${s.items.length} Elemente im Paket
                                    </div>
                                </div>
                                <span class="suggestion-badge badge-pending">Ausstehend</span>
                            </div>
                            
                            <div style="background-color: white; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                                <strong>Enthaltene Elemente:</strong>
                                ${s.items.map((item, idx) => {
                                    const typeConfig = markerTypes[item.type];
                                    let coordInfo;
                                    if (item.isRoute && item.pointsString) {
                                        const pointCount = item.pointsString.split('|').length;
                                        coordInfo = `${pointCount} Wegpunkte`;
                                    } else if (item.isRoute && item.points) {
                                        coordInfo = `${item.points.length} Wegpunkte`;
                                    } else {
                                        coordInfo = `${item.lat.toFixed(5)}, ${item.lng.toFixed(5)}`;
                                    }
                                    return `
                                        <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="touritem_${s.id}_${idx}" checked style="cursor: pointer;">
                                            <label for="touritem_${s.id}_${idx}" style="cursor: pointer; flex: 1;">
                                                ${idx + 1}. ${typeConfig.icon} ${item.name} (${coordInfo})
                                            </label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <p style="font-size: 0.85rem; color: #999;">Eingereicht: ${new Date(s.createdAt).toLocaleString('de-DE')}</p>
                            
                            <div class="suggestion-actions">
                                <button class="btn btn-secondary" onclick="previewTourpaket(${s.id})">üëÅÔ∏è Auf Karte zeigen</button>
                                <button class="btn btn-approve" onclick="approveSelectedTourItems(${s.id})">‚úÖ Auswahl annehmen</button>
                                <button class="btn btn-approve" onclick="approveTourpaket(${s.id})">‚úÖ Alles annehmen</button>
                                <button class="btn btn-reject" onclick="rejectSuggestion(${s.id})">‚ùå Ablehnen</button>
                            </div>
                        </div>
                    `;
                }
                
                // Normaler Marker-Vorschlag
                const typeConfig = markerTypes[s.type];
                let coordInfo;
                if (s.isRoute && s.pointsString) {
                    const pointCount = s.pointsString.split('|').length;
                    coordInfo = `${pointCount} Wegpunkte`;
                } else if (s.isRoute && s.points) {
                    coordInfo = `${s.points.length} Wegpunkte`;
                } else {
                    coordInfo = `${s.lat.toFixed(5)}, ${s.lng.toFixed(5)}`;
                }
                
                return `
                    <div class="suggestion-card">
                        <div class="suggestion-header">
                            <div>
                                <div class="suggestion-title">${typeConfig.icon} ${s.name}</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">
                                    ${typeConfig.name} ‚Ä¢ ${coordInfo}
                                </div>
                            </div>
                            <span class="suggestion-badge badge-pending">Ausstehend</span>
                        </div>
                        
                        ${s.difficulty ? `<p><strong>Schwierigkeit:</strong> ${getDifficultyLabel(s.difficulty)}</p>` : ''}
                        ${s.description ? `<p><strong>Beschreibung:</strong> ${s.description}</p>` : ''}
                        <p style="font-size: 0.85rem; color: #999;">Eingereicht: ${new Date(s.createdAt).toLocaleString('de-DE')}</p>
                        
                        <div class="suggestion-actions">
                            <button class="btn btn-approve" onclick="approveSuggestion(${s.id})">‚úÖ Annehmen</button>
                            <button class="btn btn-reject" onclick="rejectSuggestion(${s.id})">‚ùå Ablehnen</button>
                            <button class="btn btn-primary" onclick="previewSuggestion(${s.id})" style="flex: 0.5;">üëÅÔ∏è Vorschau</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAdminMarkerList() {
            const list = document.getElementById('adminMarkerList');
            document.getElementById('totalMarkerCount').textContent = markers.length;
            
            if (markers.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Keine Marker vorhanden</p>';
                return;
            }

            list.innerHTML = markers.map(m => {
                const t = markerTypes[m.type];
                const coordDisplay = m.isRoute ? `${m.points.length} Wegpunkte` : `üìç ${m.lat.toFixed(4)}, ${m.lng.toFixed(4)}`;
                
                return `
                    <div class="marker-item" style="cursor: default;">
                        <div class="marker-item-header">
                            <span class="marker-item-title">${m.name}</span>
                            <span class="marker-item-type">${t.icon}</span>
                        </div>
                        <div class="marker-item-coords">${coordDisplay}</div>
                        <button class="delete-marker-btn" onclick="deleteMarker(${m.id})" style="width: 100%; margin-top: 0.5rem;">üóëÔ∏è L√∂schen</button>
                    </div>
                `;
            }).join('');
        }

        function approveSuggestion(id) {
            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion) return;

            // Als Marker hinzuf√ºgen
            const newMarker = {
                id: Date.now(),
                name: suggestion.name,
                type: suggestion.type,
                difficulty: suggestion.difficulty,
                description: suggestion.description,
                createdAt: new Date().toISOString()
            };

            if (suggestion.isRoute) {
                newMarker.isRoute = true;
                // Konvertiere pointsString zur√ºck zu Array
                if (suggestion.pointsString) {
                    newMarker.points = suggestion.pointsString.split('|').map(p => {
                        const [lat, lng] = p.split(',').map(parseFloat);
                        return [lat, lng];
                    });
                } else if (suggestion.points) {
                    // Fallback f√ºr alte Daten
                    newMarker.points = suggestion.points;
                }
            } else {
                newMarker.lat = suggestion.lat;
                newMarker.lng = suggestion.lng;
            }

            markers.push(newMarker);
            saveMarkersToStorage(); // Lokal speichern
            addMarkerToMap(newMarker);
            updateMarkerList();

            // AUCH zu Firebase hochladen f√ºr andere User!
            if (db) {
                // Erstelle Firebase-kompatible Version
                const firebaseMarker = { ...newMarker };
                if (firebaseMarker.points) {
                    // Konvertiere Points zu String
                    firebaseMarker.pointsString = firebaseMarker.points.map(p => `${p[0]},${p[1]}`).join('|');
                    delete firebaseMarker.points; // Entferne verschachteltes Array
                }
                
                db.collection('markers').add(firebaseMarker)
                    .then(() => console.log('‚úÖ Marker zu Firebase hochgeladen'))
                    .catch(error => console.error('‚ùå Firebase Marker-Upload Fehler:', error));
            }

            // SOFORT aus lokaler Liste entfernen (nicht auf Firebase warten)
            markerSuggestions = markerSuggestions.filter(s => s.id !== id);
            updateAdminDashboard(); // UI sofort aktualisieren
            
            alert('‚úÖ Vorschlag wurde angenommen und zur Karte hinzugef√ºgt!');

            // In Firebase als "approved" markieren (im Hintergrund)
            if (db && suggestion.firebaseId) {
                db.collection('suggestions').doc(suggestion.firebaseId).update({
                    status: 'approved'
                }).catch(error => {
                    console.error('Firebase Fehler (ignoriert):', error);
                });
            } else {
                // Offline-Fallback
                suggestion.status = 'approved';
                saveSuggestionsToStorage();
            }
        }

        function approveTourpaket(id) {
            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion || suggestion.type !== 'tourpaket') return;

            // Alle Elemente des Tourpakets als Marker hinzuf√ºgen
            const groupId = Date.now();
            const groupName = suggestion.name;

            suggestion.items.forEach((item, index) => {
                const newMarker = {
                    id: Date.now() + index,
                    name: item.name,
                    type: item.type,
                    difficulty: item.difficulty,
                    description: item.description,
                    groupId: groupId,
                    groupName: groupName,
                    createdAt: new Date().toISOString()
                };

                if (item.isRoute) {
                    newMarker.isRoute = true;
                    // Konvertiere pointsString zur√ºck zu Array
                    if (item.pointsString) {
                        newMarker.points = item.pointsString.split('|').map(p => {
                            const [lat, lng] = p.split(',').map(parseFloat);
                            return [lat, lng];
                        });
                    } else if (item.points) {
                        newMarker.points = item.points;
                    }
                } else {
                    newMarker.lat = item.lat;
                    newMarker.lng = item.lng;
                }

                markers.push(newMarker);
                addMarkerToMap(newMarker);
                
                // AUCH zu Firebase hochladen!
                if (db) {
                    const firebaseMarker = { ...newMarker };
                    if (firebaseMarker.points) {
                        firebaseMarker.pointsString = firebaseMarker.points.map(p => `${p[0]},${p[1]}`).join('|');
                        delete firebaseMarker.points;
                    }
                    
                    db.collection('markers').add(firebaseMarker)
                        .then(() => console.log('‚úÖ Tourpaket-Marker zu Firebase hochgeladen'))
                        .catch(error => console.error('‚ùå Firebase Fehler:', error));
                }
            });

            saveMarkersToStorage();
            updateMarkerList();

            // SOFORT aus lokaler Liste entfernen
            markerSuggestions = markerSuggestions.filter(s => s.id !== id);
            updateAdminDashboard(); // UI sofort aktualisieren

            alert(`‚úÖ Tourpaket "${groupName}" mit ${suggestion.items.length} Elementen wurde angenommen!`);

            // In Firebase als "approved" markieren (im Hintergrund)
            if (db && suggestion.firebaseId) {
                db.collection('suggestions').doc(suggestion.firebaseId).update({
                    status: 'approved'
                }).catch(error => {
                    console.error('Firebase Fehler (ignoriert):', error);
                });
            } else {
                // Offline-Fallback
                suggestion.status = 'approved';
                saveSuggestionsToStorage();
            }
        }

        function approveSelectedTourItems(id) {
            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion || suggestion.type !== 'tourpaket') return;

            // Sammle ausgew√§hlte Items
            const selectedItems = [];
            suggestion.items.forEach((item, idx) => {
                const checkbox = document.getElementById(`touritem_${id}_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedItems.push(item);
                }
            });

            if (selectedItems.length === 0) {
                alert('‚ö†Ô∏è Keine Elemente ausgew√§hlt!');
                return;
            }

            // Alle ausgew√§hlten Elemente als Marker hinzuf√ºgen
            const groupId = Date.now();
            const groupName = suggestion.name;

            selectedItems.forEach((item, index) => {
                const newMarker = {
                    id: Date.now() + index,
                    name: item.name,
                    type: item.type,
                    difficulty: item.difficulty,
                    description: item.description,
                    groupId: groupId,
                    groupName: groupName,
                    createdAt: new Date().toISOString()
                };

                if (item.isRoute) {
                    newMarker.isRoute = true;
                    if (item.pointsString) {
                        newMarker.points = item.pointsString.split('|').map(p => {
                            const [lat, lng] = p.split(',').map(parseFloat);
                            return [lat, lng];
                        });
                    } else if (item.points) {
                        newMarker.points = item.points;
                    }
                } else {
                    newMarker.lat = item.lat;
                    newMarker.lng = item.lng;
                }

                markers.push(newMarker);
                addMarkerToMap(newMarker);
                
                // Zu Firebase hochladen
                if (db) {
                    const firebaseMarker = { ...newMarker };
                    if (firebaseMarker.points) {
                        firebaseMarker.pointsString = firebaseMarker.points.map(p => `${p[0]},${p[1]}`).join('|');
                        delete firebaseMarker.points;
                    }
                    
                    db.collection('markers').add(firebaseMarker)
                        .then(() => console.log('‚úÖ Ausgew√§hlter Marker zu Firebase hochgeladen'))
                        .catch(error => console.error('‚ùå Firebase Fehler:', error));
                }
            });

            saveMarkersToStorage();
            updateMarkerList();

            // SOFORT aus lokaler Liste entfernen
            markerSuggestions = markerSuggestions.filter(s => s.id !== id);
            updateAdminDashboard();

            alert(`‚úÖ ${selectedItems.length} von ${suggestion.items.length} Elementen aus "${groupName}" wurden angenommen!`);

            // In Firebase als "approved" markieren
            if (db && suggestion.firebaseId) {
                db.collection('suggestions').doc(suggestion.firebaseId).update({
                    status: 'approved'
                }).catch(error => console.error('Firebase Fehler (ignoriert):', error));
            } else {
                suggestion.status = 'approved';
                saveSuggestionsToStorage();
            }
        }

        function previewTourpaket(id) {
            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion || suggestion.type !== 'tourpaket') return;

            // Sammle alle Koordinaten
            const allCoords = [];
            
            suggestion.items.forEach(item => {
                if (item.isRoute) {
                    let points;
                    if (item.pointsString) {
                        points = item.pointsString.split('|').map(p => {
                            const [lat, lng] = p.split(',').map(parseFloat);
                            return [lat, lng];
                        });
                    } else if (item.points) {
                        points = item.points;
                    }
                    if (points) allCoords.push(...points);
                } else {
                    allCoords.push([item.lat, item.lng]);
                }
            });

            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            closeAdminDashboard();
        }

        function rejectSuggestion(id) {
            if (!confirm('Vorschlag wirklich ablehnen?')) return;

            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion) return;

            // SOFORT aus lokaler Liste entfernen (nicht auf Firebase warten)
            markerSuggestions = markerSuggestions.filter(s => s.id !== id);
            updateAdminDashboard(); // UI sofort aktualisieren

            // In Firebase als "rejected" markieren (im Hintergrund)
            if (db && suggestion.firebaseId) {
                db.collection('suggestions').doc(suggestion.firebaseId).update({
                    status: 'rejected'
                }).catch(error => {
                    console.error('Firebase Fehler (ignoriert):', error);
                });
            } else {
                // Offline-Fallback
                suggestion.status = 'rejected';
                saveSuggestionsToStorage();
            }
        }

        function previewSuggestion(id) {
            const suggestion = markerSuggestions.find(s => s.id === id);
            if (!suggestion) return;

            if (suggestion.isRoute) {
                let points;
                if (suggestion.pointsString) {
                    points = suggestion.pointsString.split('|').map(p => {
                        const [lat, lng] = p.split(',').map(parseFloat);
                        return [lat, lng];
                    });
                } else if (suggestion.points) {
                    points = suggestion.points;
                }
                
                if (points && points.length > 0) {
                    const bounds = L.latLngBounds(points);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } else {
                map.setView([suggestion.lat, suggestion.lng], 15);
            }

            closeAdminDashboard();
        }

        function saveSuggestionsToStorage() {
            // Lokal speichern (Backup)
            localStorage.setItem('mtb_suggestions', JSON.stringify(markerSuggestions));
            
            // NICHT zu Firebase schicken - Vorschl√§ge werden direkt beim Erstellen hochgeladen
        }

        function loadSuggestionsFromStorage() {
            if (!db) {
                // Offline: Aus localStorage laden
                const stored = localStorage.getItem('mtb_suggestions');
                if (stored) {
                    markerSuggestions = JSON.parse(stored);
                }
                return;
            }

            // ECHTZEIT-LISTENER f√ºr Vorschl√§ge
            db.collection('suggestions')
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    console.log('üîÑ Vorschl√§ge-√Ñnderung erkannt von Firebase');
                    markerSuggestions = [];
                    
                    snapshot.forEach(doc => {
                        markerSuggestions.push({
                            firebaseId: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Admin-Dashboard aktualisieren wenn offen
                    if (document.getElementById('adminDashboard')?.classList.contains('active')) {
                        updateAdminDashboard();
                    }
                }, (error) => {
                    console.error('Fehler beim Laden der Vorschl√§ge:', error);
                    // Fallback: localStorage
                    const stored = localStorage.getItem('mtb_suggestions');
                    if (stored) {
                        markerSuggestions = JSON.parse(stored);
                    }
                });
        }

        function exportMarkersAdmin() {
            if (markers.length === 0) {
                alert('‚ö†Ô∏è Keine Marker zum Exportieren!');
                return;
            }

            let csv = 'name,coordinates,type,difficulty,description,groupId,groupName\n';
            markers.forEach(m => {
                let coords;
                if (m.isRoute && m.points) {
                    coords = m.points.map(p => `${p[0]}/${p[1]}`).join('|');
                } else {
                    coords = `${m.lat},${m.lng}`;
                }
                csv += `"${m.name}","${coords}",${m.type},${m.difficulty || 'medium'},"${m.description || ''}",${m.groupId || ''},${m.groupName || ''}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mtb-backup-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Backup erstellt und heruntergeladen!');
        }

        function importMarkersAdmin() {
            const fileInput = document.getElementById('adminImportFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ö†Ô∏è Bitte w√§hle eine CSV-Datei aus!');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());

                    if (lines.length === 0) throw new Error('CSV-Datei ist leer');

                    const dataLines = lines.slice(1);
                    if (dataLines.length === 0) throw new Error('CSV enth√§lt keine Daten');

                    const confirmed = confirm(
                        `${dataLines.length} Marker gefunden.\n\n‚ö†Ô∏è ACHTUNG: Alle bestehenden Marker werden ERSETZT!\n\nFortfahren?`
                    );
                    if (!confirmed) return;

                    // Import-Logik (wie vorher)
                    markers = [];
                    let successCount = 0;
                    let errorCount = 0;

                    dataLines.forEach((line, index) => {
                        try {
                            const values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                            if (values) {
                                const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
                                
                                const name = cleanValues[0];
                                const coordsStr = cleanValues[1];
                                const type = cleanValues[2]?.toLowerCase().trim();
                                const difficulty = cleanValues[3]?.toLowerCase().trim() || 'medium';
                                const description = cleanValues[4] || '';
                                const groupId = cleanValues[5] || null;
                                const groupName = cleanValues[6] || null;

                                if (coordsStr.includes('|')) {
                                    // Strecke
                                    const points = coordsStr.split('|').map(p => {
                                        const [lat, lng] = p.split('/').map(parseFloat);
                                        return [lat, lng];
                                    });

                                    markers.push({
                                        id: Date.now() + index,
                                        name, type, difficulty, description,
                                        isRoute: true, points, groupId, groupName,
                                        createdAt: new Date().toISOString()
                                    });
                                } else {
                                    // Punkt
                                    const coords = coordsStr.split(',');
                                    const lat = parseFloat(coords[0]);
                                    const lng = parseFloat(coords[1]);

                                    markers.push({
                                        id: Date.now() + index,
                                        name, lat, lng, type, difficulty, description, groupId, groupName,
                                        createdAt: new Date().toISOString()
                                    });
                                }
                                successCount++;
                            }
                        } catch (error) {
                            errorCount++;
                        }
                    });

                    if (successCount > 0) {
                        saveMarkersToStorage();
                        reloadMap();
                        updateMarkerList();
                        updateAdminMarkerList();
                    }

                    alert(`‚úÖ ${successCount} Marker importiert!${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} Fehler` : ''}`);
                } catch (error) {
                    alert('‚ùå Fehler beim Import: ' + error.message);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        }

        // ==================== BESUCHER-TRACKING ====================
        
        function trackPageView() {
            if (!db) {
                console.log('‚ö†Ô∏è Kein Firebase - Besucher-Tracking √ºbersprungen');
                return;
            }

            // Pr√ºfe ob dieser Besuch bereits gez√§hlt wurde (in dieser Session)
            const hasVisited = sessionStorage.getItem('mtb_visited');
            
            if (hasVisited) {
                console.log('‚úÖ Besucher bereits in dieser Session gez√§hlt');
                return;
            }

            // Markiere als besucht in dieser Session
            sessionStorage.setItem('mtb_visited', 'true');

            const statsRef = db.collection('stats').doc('pageviews');
            
            // Verwende Firebase increment() um Z√§hler zu erh√∂hen
            statsRef.set({
                count: firebase.firestore.FieldValue.increment(1),
                lastVisit: new Date().toISOString()
            }, { merge: true })
                .then(() => {
                    console.log('‚úÖ Seitenaufruf gez√§hlt');
                })
                .catch(error => {
                    console.error('‚ùå Besucher-Tracking Fehler:', error);
                });
        }

        function loadPageViewStats() {
            if (!db) {
                document.getElementById('pageviewCount').textContent = '0';
                return;
            }

            db.collection('stats').doc('pageviews')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const count = data.count || 0;
                        document.getElementById('pageviewCount').textContent = count.toLocaleString('de-DE');
                        
                        // Letzter Besuch anzeigen
                        if (data.lastVisit) {
                            const lastVisit = new Date(data.lastVisit);
                            document.getElementById('lastVisit').textContent = lastVisit.toLocaleString('de-DE');
                        }
                    } else {
                        document.getElementById('pageviewCount').textContent = '0';
                    }
                }, (error) => {
                    console.error('‚ùå Fehler beim Laden der Stats:', error);
                    document.getElementById('pageviewCount').textContent = '?';
                });
        }
    </script>
</body>
</html>